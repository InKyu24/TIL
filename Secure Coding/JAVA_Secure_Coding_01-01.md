## 해킹방어를 위한 JAVA 시큐어코딩

### 안전한 소프트웨어 개발 방법론

소프트웨어 개발보안은 안전한 소프트웨어를 개발하기 위해 소스 코드에 존재할 수 있는 잠재적인 보안약점을 제거하고 보안을 고려해 기능을 설계, 구현하는 일련의 보안 활동으로, 소프트웨어 개발 과정에서 실행된다.

#### 시큐어코딩의 개요

##### 소프트웨어 개발보안의 필요성

웹이 대중화되고 많은 기업들이 웹을 통해 서비스를 제공하면서 기업의 자산을 노리는 사이버 공격 또한 웹을 주요 타겟으로 삼게 되었다. 카카오톡과 같은 서비스들은 모바일 앱처럼 보이지만 실제로는 웹 기반의 애플리케이션들이다. 기업에서 제공하고 있는 서비스들은 고객의 개인 정보를 다루고 잇으며 이러한 정보를 사용하고 관리하는 많은 시스템들은 고객의 개인 정보를 다루고 있다.

한국인터넷진흥원의 자료에 의하면 전체 해킹 시도 중 70% 이상이 웹을 통해 이루어지고 있는 만큼 웹 보안은 선택이 아닌 필수 사항으로 인식하여야 한다.

최근 웹을 통한 서비스 환경을 살펴 보면 많은 기업들이 방화벽이나 IDS/IPS와 같은 보안 장비를 구축하여 보안을 강화하고 있기 때문에 원격으로 시스템의 취약한 서비스를 이용한 공격은 쉽지 않다. 즉, 80번 포트를 제외한 다른 서비스 포트들은 다 막아놓았기 때문에 해커들은 대상 시스템을 침입하기 위해서는 80번 서비스(웹)를 집중적으로 공략할 수밖에 없는 상황이다. 하지만 웹 보안은 전문가라 하여도 안전한 웹 보안을 보장하기가 쉽지 않다. 기업마다 제각각 다른 방식으로 애플리케이션을 개발하거나 서비스 환경을 구축하기 때문에 자사의 IT시스템에 대한 적절한 보안대책을 구축하고 운영하는 곳은 많지 않은 것이 현실이다.

> IDS (Intrusion Detection System) : 전통적인 방화벽이 탐지할 수 없는 악의적인 네트워크 트래픽 및 컴퓨터 사용을 탐지하기 위한 시스템이다. IDS는 취약한 서비스에 대한 네트워크 공격과 애플리케이션에서의 데이터 처리공격, 권한상승 및 침입자 로그인, 침입자에 의한 주요 파일 접근, 악성 소프트웨어와 같은 호스트 기반 공격이 발생하면 해당 이벤트를 발생시키고, 데이터베이스에 기록하거나, 시스템 규칙을 사용하여 수신된 보안 이벤트를 이용하여 경고하는 기능을 수행한다.
>
> IPS (Intrusion Prevention System) : IDS와 유사하게 동작하지만 보다 능동적으로 허용되지 않은 사용자나 서비스에 대해 사용을 거부하여 내부자원을 보호하는 기능을 수행
>
> 80번 포트 : 웹 서버의 기본 포트, 80번 포트가 아닌 경우에는 http://www.domain.com:8080 과 같은 형식으로 호스트 이름 끝부분에 콜론과 포트번호를 붙인다. 일반적으로 개인용 인터넷 회선에 대하여는 인터넷 회선 제공업체(ISP)에서 서버 운영을 하지 못하도록 80번 포트를 막는 경우가 대부분이다.

* 웹 기반의 공격 유형
  * 외부망을 통한 1차 해킹
    * 웹서버의 취약점을 공격하는 방법 : 웹사이트를 통해 이루어지며, SQL인젝션이나 파일 업로드 취약점과 같은 웹 애플리케이션 취약점 공격을 시도하여 관리자 계정을 확보하여 내부시스템으로 침투할 수 있는 발판을 만들고 2차 해킹을 시도하는 방식
    * 내부 PC를 공격하는 방법 : 내부 사용자의 실수로 웹사이트나 메일을 통해 악성코드가 설치되고, 해당 PC가 2차 공격에 사용되는 방식
  * 내부망에서의 2차 해킹 : DB 서버나 업무서버에 저장된 중요 정보를 유출하거나, 내부 업데이트 서버를 이용하여 내부망의 모든 PC를 감염시켜 사용 불능 상태로 만들거나 좀비 상태로 만들어 또 다른 공격에 사용되도록 제어하게 된다.

최근 기업환경은 모바일 기기 서비스, 클라우드 환경과 같은 다양한 접속환경을 제공하므로해서 공격 기법도 더 복잡하게 진화하고 있다.

* 네트워크 기반의 웹 애플리케이션 서비스의 보안
  * 클라이언트 보안
  * 네트워크 보안
    * 네트워크 계층에서는 방화벽과 IDS/IPS 장비들을 이용하여 안전한 트래픽만 내부로 유입될 수 있도록 제어한다.
    * 네트워크 방화벽은 기본적으로 네트워크를 통해 들어오는 패킷에 대해 사전에 관리자가 설정해 놓은 IP주소, 포트번호 기반의 접근제어목록(ACL, Access Control List) 규칙에 따라 허용 또는 차단하는 기능을 수행한다.
    * IDS/IPS에서 이루어지는 네트워크 계층에서의 유해성 검사는 애플리케이션 계층에 대한 이해가 없이 이뤄지기 때문에 애플리케이션 취약점을 노린 공격에 대해서는 방어가 불가능하다는 한계가 있다.
    * 네트워크 보안 장비인 방화벽이나 IDS/IPS는 정의된 룰이나 시그니처를 이용하여 안전하지 않은 패킷을 필터링하는 정책을 사용하지만 잘못 관리된 룰이나 새로운 패턴의 공격으로 약 3.5%의 침해사고율을 보여준다. 
  * 시스템 보안
    * 시스템 보안은 대부분 OS와 연관된 항목이 많다. 주기적인 보안 업데이트 및 패치를 통해 알려진 웹 위협에 대비해야 하며, 주기적으로 시스템 악성코드 점검을 통해 시스템이 항상 안전한 상태로 유지되도록 한다. 실시간 패치 관리나 안티 바이러스 솔루션 등이 시스템 보안 솔루션으로 사용된다.
  * 애플리케이션 보안
    * 보안 장비나 솔루션을 적용하여 외부로부터의 공격을 방어하는 것이 어느 정도 가능하지만 애플리케이션의 논리적인 취함에 대한 문제는 해결이 어렵다.
    * 현재 이루어지고 있는 웹 공격의 90% 이상이 웹 애플리케이션을 노린 공격이라고 해도 과언이 아니다. 웹 방화벽을 설치하여 애플리케이션 취약점에 대한 공격을 어느 정보 필터링하고 있지만 실제 로직상의 결함, 인증/인가가 적절하게 구현되지 않은 애플리케이션들은 주요 공격 대상이 되고 있다. 결국 안전한 웹을 구축하고자 한다면 안전한 웹 애플리케이션 보안 구축이 가장 절실한 현실이다.
    * 웹 방화벽도 네트워크 방화벽과 IDS/IPS와 마찬가지로 공격 시그니처를 룰로 정의하여 해당 패턴의 요청을 차단하게 되는데 새로운 공격 패턴이나 룰 관리 부실로 인한 침해사고율이 약 10% 정도이다.
    * 침해사고의 75%는 취약한 웹 애플리케이션이 원인이 된다. 많은 기업환경에서 보안강화를 위해 네트워크 보안이나 시스템 보안에 많은 투자를 하고 있지만 실제 가장 많은 침해사고가 발생되는 애플리케이션에 대해 투자가 소홀했던 것은 사실이다. 하지만 최근 소프트웨어 개발보안 방법론의 적용이나 소스 코드 취약점 제거 의무화 같은 정책을 통해 취약한 애플리케이션을 줄이기 위한 노력이 이루어지고 있다.
  * 데이터베이스 보안

##### 침해 사료 사례

보안 사고 동향의 분석결과를 보면 최근 공격 패턴은 위협 수준이 상당히 높은 개인정보 유출 사고, 서비스 거부, APT 위협들이 주류이다. 이미 기업들은 보안을 강화하기 위해 기업 내부의 시스템 접근을 차단할 수 있도록 구축했지만 사용자 서비스를 위해 웹만이 오픈되어 있는 환경이 때문에 공격자들은 집요하게 웹의 취약점을 이용한 공격을 수행하고 있다.

> APT 위협 :

위협의 유형이 바뀐다는 것은 대응 방법도 바뀌어야 한다는 것이다. 기존에는 인적, 물리적 보안과 기술적인 보안이 이원화되어 시스템 단위의 정보보안 관점에서 보안에 접근했다면, 이제는 이를 일원화하여 개인정보나 기술정보와 같은 특정 정보를 보호하는 관점으로 대응하여야 한다. 즉, IT 기반의 대응이 아니라 서비스/비즈니스 관점에서 대응하여야 한다.

현재의 기업은 시스템에서 동작하는 서비스가 구현되어야 현실세계의 서비스가 가능한 구조를 가지고 있다. 이것이 서비스를 구현하는 소프트웨어의 안전성이 보장될 필요가 있는 이유이다.

최근 여러 가지 보안 사고 사례를 통해 소프트웨어 취약점이 어떻게 침해 사고의 원인이 되는지 살펴보자.

* 보안 사고 사례 1) 웹 애플리케이션 취약점 이용

  * 접근제어 기능 취약한 웹 애플리케이션을 대상으로 요금명세서 조회에 사용되는 고객번호를 무작위로 대입해 전송한다. 입력된 고객번호가 로그인한 사용자의 고객번호인지 체크하지 않고 조회 작업 요청을 처리함으로써 개인정보 1,200만 건이 유출된 사례이다.

  * 공격자는 다음과 같은 순서로 공격을 수행한다.

    1. 공격자가 시스템에 로그인
    2. 요금조회 및 개인정보 조회 페이지에서 로그인한 계정의 정보를 조회
    3. Paros를 이용해 9자리의 고객번호를 무작위로 대입해 요청 전송
    4. 위조된 요청 결과 수신
    5. 허가에 대한 체크 없이 DB 조회 요청 처리
    6. 조회 결과 전송

    > Paros : 웹 애플리케이션의 보안을 점검하기 위해 사용하는 웹 프록시 툴로 서버와 클라이언트 사에에 모든 Request와 Response를 기록한다.
    >
    > 웹 프록시 : 웹 클라이언트와 웹 서버 사이에 위치하여 데이터 전달을 중개하는 역할을 한다.

* 보안 사고 사례 2) 취약한 웹 서버를 공격해 내부망 해킹 및 악성코드 삽입

  * 파일 업로드 취약점을 가진 서버를 통해 키로그를 업로드 한 뒤 내부망의 윈도우 서버에 대한 계정 정보를 추출하고 터미널로 접속해 내부망의 서버에 점진적으로 악성코드를 설치한다. 이로써 관리자 PC를 포함한 대부분의 내부 서버가 악성코드에 감염되거나 악성코드를 배포하는 서버로 동작하게 되어, 해당 사이트에 접속하는 사용자들에게 악성코드를 감염시킨 사례이다.

  * 공격자는 다음과 같은 순서로 공격을 수행한다.

    1. [1일차] 취약한 서버로 파일 업로드 웹 공격
    2. [2일차] 취약한 서버에 키로그 설치 및 모니터링
    3. 관리자는 피해 시스템에서 다른 윈도우 서버에 터미널 접속
    4. [2~9일차] 윈도우 서버들에 악성코드 설치
    5. 관리자는 피해 시스테에서 관리자 PC 원격접속
    6. [9일차] 관리자 PC에 악성코드 설치
    7. [10일차] 관리자 PC에서 FTP를 이용해 공격 대상 웹 서버에 접속한 후 js 파일에 iframe 삽입
    8. [2개월 후] 공격 대상 웹 서버 FTP에 접속해 js 파일을 수정

    > 키로그 (Key Log) : 키보드에 입력한 키의 흔적을 남기는 프로그램 
    >
    > iframe (inline frame): 다른 HTML 페이지를 현재 페이지에 포함시키는 중첩된 브라우저로 이를 이용하면 웹 페이지 내에서 어떠한 제한 없이 다른 페이지를 불러와서 삽입할 수 있다.

* 보안 사고 사례 3) 계정 관리 미비, 암호화 정책 미비, 업로드 취약점, 관제 시스템 미비 등 복합적인 요인으로 인한 침해 사고

  * 계정관리 취약에서 보안관제미흡까지 복합적인 원인으로 인해 42만 명의 고객 개인정보와 약 1만 3,000명의 금융 거래 정보가 유출된 사고이다.
  * 공격자는 다음과 같은 순서로 공격을 수행한다.
    1. 퇴직한 직원이 사용하던 ID와 비밀번호를 이용해 차량정비내역조회 서버와 광고메일발송 서버에 침투
    2. 차량정비내역조회 서버를 통해 개인정보를 조회. 해당 서버는 개인정보를 조회하는 이력을 로그 파일로 남기고 있었으며, 로그 파일 자체를 암호화하지 않음
    3. 화면을 복사하거나 해킹 프로그램을 설치하고 로그 파일을 다운로드하는 방식으로 고객정보를 유출

* 보안 사고 사례 4) OpenSSL 하트 블리드 취약점

  * OpenSSL을 사용할 때 서버와 클라이언트 사이에서 안정적인 연결을 유지하기 위해 클라이언트가 임의의 정보를 정보의 길이와 함께 서버에 전달하면, 서버에서는 수신된 정보를 다시 클라이언트에 응답해서 연결 상태를 알려주기 위해 하트비트라는 방식을 사용한다. 이 경우 서버의 프로그램에서 클라이언트가 전송한 실제 메시지의 길이와 요청하는 메시지의 길이를 비교하지 않고 처리한다면, 액세스되지 말아야 하는 메모리 상의 정보가 유출되는 취약점이 발생한다.

  * 공격 단계는 다음과 같다.

    1. 클라이언트가 서버에 [Request Data : Hello Request Length: 3000]이라고 전송하면, 서버에서 실제 전송된 Data의 길이가 Request Length와 일치하는지 검사한다. 길이가 서로 다른 경우 잘못된 정보로 인식하고 응답하지 말아야 한다.
    2. 서버가 Request Length 값을 사용해 3,000바이트를 응답하면 Hello가 저장된 메모리에서부터 3,000바이트를 읽어 전송하게 되어, 메모리 상의 중요 데이터가 노출될 수 있다.

    > 클라이언트는 한 번에 최대 64KB의 정보를 요청할 수 있다. 실제 64KB에 저장되는 정보는 많은 것은 아니지만 지속적으로 정보를 수집하면 메모리에 저장된 개인키나 관리정보와 같은 민감한 정보를 얻을 수도 있다.

##### 보안취약점 정보 활용

보안취약점에 대한 원인과 해당 취약점으로 인한 침해 사고 사례 그리고 대응 방법들은 웹사이트나 문서들을 통해 정보를 취득하고 활용할 수 있다.

* CWE (Common Weakness Enumeration)
  * 미국 국토안보부에서 관리하고 있으며, 소프트웨어의 ㅜ치약점을 사전식으로 분류해 프로그래머가 쉽게 접근할 수 있도록 구성되어 있다.
  * 수집된 취약점 항목을 뷰, 카테고리, 취약점, 복합요소를 기준으로 분류해 살펴볼 수 있으며, 취약점 항목에 대한 갱신은 현재도 지속적으로 이뤄지고 있다.
  * CWE는 해당 취약점에 대한 정의, 설명, 해당 취약점의 플랫폼(언어), 방향, 빈도 및 예제 코드 그리고 이를 완화시키기 위한 방법론을 기술하고 있다.
* CWSS (Common Weakness Scoring System)
  * CWSS는 취약저의 위험성을 정량화하기 위한 점수 체계이다.
  * 애플리케이션의 아키텍쳐, 설계, 코드 또는 구현 상에 존재하는 다양한 취약점들과 소프트웨어 보안의 관점에서 심각한 문제를 초래할 수 있는 취약점들에 대해 상대적인 중요도를 결정하기 위한 체계로 활용된다.
  * 현재 취약점을 평가하는 방법으로 보안취약점에 대한 평가체계인 CVSS(Common Vulnerability Scoring System)가 존재하며, 일반적인 취약점을 위한 유사한 점수체계인 CWSS를 만들기 위한 연구가 CERT 등을 주축으로 진행되고 있다. CVSS에서는 '기본', '임시', '환경' 유형으로 세분화해서 취약점의 심각성을 기술하고 있다. CWSS는 이보다 좀 더 광범위한 점수체계로서 3개 메트릭 그룹의 18가지 서로 다른 요소 점수를 이용해 보안약점의 중요도를 계산한다. 3개 메트릭 그룹 가운데 첫 번째는 보안약점의 내재적인 특성과 찾아진 약점의 신뢰도, 제어의 강도를 표현하는 Base Finding 그룹이고, 두 번째는 공격자가 존재하는 약점을 찾아내서 이용할 수 있는 난이도를 표현하는 Attack Surface 그룹이다. 마지막 세 번째는 사업 모델이나 공격 난이도, 외부 제어의 존재 여부를 표현하는 Environment 그룹이다.
* SANS (SysAdmin, Audit, Network, Security)
  * SANS는 1989년에 설립된 산학협동연구소로 이곳에서 제시한 SANS Top 25 Most Dangerous Programming Errors' 목록은 CWE에 등록된 1,000여 개의 소프트웨어 취약점 중 가장 위험한 25가지 소프트웨어 오류를 정리했다.
  * 최종 결과를 점수화하고 순위를 정하기 위해 CWSS를 사용했으며, 취약점 뿐만 아니라 개발자들이 취약점을 줄이거나 완화할 수 있는 '주요 완화 방법'도 같이 설명하고 있다.
  * SANS에서 도출한 상위 25개 취약점은 구성요소 간 안전하지 않은 상호작용(6개), 위험한 자원 관리(8개), 방어 미비(11개)와 같이 3개 카테고리로 분류한다.
    * 안전하지 않은 상호 작용
      * SQL인젝션, Command인젝션, XSS, 위험 파일 업로드 허용, CSRF, Open Redirect
    * 위험한 자원 관리
      * 버퍼 오버플로우, 금지된 디렉토리 접근 허용, 무결정 검사 없이 코드 다운로드, 신뢰할 수 없는 기능 포함, 위험성 잠재된 함수 사용, 버퍼 크기 잘못 계산, 문자열 미통제, 정수 오버플로우 또는 랩 어라운드
    * 방어 미비
      * 핵심 기능 인증 누락, 인가 기능 누락, 인증 데이터를 코드에 기록, 데이터 암호화 누락, 신뢰할 수 없는 입력 정보에 의존해 보안성을 결정, 불필요한 권한으로 실행, 올바르지 않은 인가 방식, 핵심 자원에 대한 잘못된 권한 설정, 안전하지 않은 암호화 알고리즘 사용, 인증 시도 횟수를 제한하지 않음, 솔트 없이 일방향 해시 사용
*  CVE (Common Vulnerabilities and Exposures)
  * CVE는 시간에 따라 감지된 보안취약점 또는 위험 노출을 정리해둔 목록이다.
  * 기본적으로 MITRE를 주축으로 해서 각종 소프트웨어 개발 회사와 CERT/CC 같은 기관에서 감지된 보안취약점을 보고하면, CVE 조정위원회를 통해 목록이 관리된다. 1999년부터 시작해서 공인된 것만 매년 8,000여 개의 목록이 추가되고 있다. CWE가 일반적인 취약점의 분류체계라고 한다면, CVE는 발견된 보안취약점의 히스토리라고 할 수 있다.
* CERT (Computer Emergency Response Team)
  * CERT는 시큐어코딩 표준(Secure Coding Standard)을 위해 각 프로그래밍 언어의 특징을 고려한 안전한 코딩 방안을 언어별로 구분해 제시하고, 각 언어의 사용자 및 학습지가 수월하게 접근하도록 지원한다. CERT에서 제공하는 자바 시큐어코딩 표준(Secure Coding Standard for JAVA)은 2009년 10월 30일 기준으로 17개 카테고리로 구성되어 있으며, 각 항목은 지속적으로 갱신되고 있다.
* OWASP (Open Web Application Security Project)
  *  OWASP Top 10 리스트는 운영 중인 웹 서버에서 발생하는 가장 많은 침해 사고 유형들을 정리한 리스트이다.
  * 이 리스트는 애플리케이션 보안을 전문으로 하는 7개 기업의 8개 데이터 셋을 토대로 하고 있으며, 데이터 셋은 수백 개의 기업, 수천 개의 애플리케이션에서 발생된 50만 개 이상의 취약점들은 포함하고 있다. 이 중 취약점 공격 가능성, 탐지 가능성, 영향 평가 등을 고려해 가장 많이 퍼져 있으며 위험도가 큰 상위 10개를 선정해 해당 문제에 대해 대응할 수 있는 기본적인 기술을 제공하며, 이를 근거로 향후 방향을 제시하고 있다.

##### 행정자치부 소프트웨어 개발보안 가이드

정부기관의 시스템 개발 프로젝트 수행 시 안전한 소프트웨어를 개발해 각종 사이버 위협으로부터 벗어날 수 있도록 소프르웨어 개발 단계부터 보안약점의 제거를 유도하는 '소프트웨어 개발보안' 의무제가 2012년 12월부터 시행되면서 이에 따른 관련 가이드가 보급되었다.

행정자치부는 2016년 12월에 기존의 구현 단계에 7개 유형, 47개 항목의 보안약점 제거를 위한 개발보안 활동을 분석, 설계 단계까지 확대하여 설계 단계에 4개 유형, 20개 항목의 보안요구항목을 추가 적용하여 소프트웨어를 개발하도록 "행정기관 및 공공기관 정보시스템 구축 및 운영 지침"을 고시하였다.



