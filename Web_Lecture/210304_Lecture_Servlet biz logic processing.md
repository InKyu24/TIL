# 서블릿 비즈니스 로직 처리

## 서블릿의 비즈니스 로직 처리 방법

웹 프로그램은 클라이언트의 요청에 대해서 비즈니스 처리 기능을 이용해 데이터 저장소에서 데이터를 조회한 후 서블릿의 응답 기능을 이용해 클라이언트에게 결과를 전송한다.

서블릿 비즈니스 처리 작업이란 서블릿이 클라이언트로부터 요청을 받으면 그 요청에 대해 작업을 수행하는 것을 의미한다. 웹 프로그램에서 대부분의 비즈니스 처리 작업은 데이터베이스 연동 관련 작업이지만 그 외에 다른 서버와 연동해서 데이터를 얻는 작업도 수행한다. 이 기능은 서블릿의 핵심 기능이라 할 수 있을만큼 중요하다.

서블릿의 비즈니스 작업의 대표적인 것들은 아래와 같다.

+ 웹 사이트 회원 등록 요청 처리 작업
+ 웹 사이트 로그인 요청 처리 작업
+ 쇼핑몰 상품 주문 처리 작업

서블릿의 세 가지 기능 중 비즈니스 처리 과정은 아래와 같다.

1. 서블릿이 클라이언트로부터 요청을 받는다.
2. 서블릿은 데이터베이스 연동과 같은 비즈니스 로직을 처리한다.
3. 서블릿은 처리 결과를 클라이언트에게 돌려준다.



## 서블릿의 데이터베이스 연동하기

서블릿에서 데이터베이스와 연동하는 과정은 자바의 데이터베이스 연동 과정과 같다. 클라이언트로부터 요청을 받으면 서블릿은 SQL문을 사용해 데이터베이스에 접근하여 작업을 한다. 이 과정에서 DAO와 VO 클래스가 사용된다. DAO 클래스와 VO 클래스가 연동해서 데이터베이스에 접근하게 된다.



### 서블릿으로 데이터베이스 내 회원정보 조회 (Web13 프로젝트 참고)

1. 웹 브라우저가 서블릿에게 정보를 요청한다.
2. MainServlet은 요청을 받은 후 DAO 객체를 생성하여, listMember() 메서드를 호출한다.
3. listMember() 메서드에서 데이터베이스와 연결한 후, SQL 문을 실행해 회원 정보를 조회한다.
4. 조회된 회원 정보를 MemberVO 속성에 설정한 후, 다시 ArrayList에 저장한다.
5. ArrayList를 다시 메서드를 호출했던 MainServlet으로 반환 후 ArrayList의 MemberVO를 차례대로 가져와 회원 정보를 HTML 태그로 만든다.
6. 만들어진 HTML 태그는 웹 브라우저로 전송되어 회원 정보를 출력한다.



## DataSource 이용해 데이터베이스 연동하기

필요할 때마다 데이터베이스와 연동해서 작업하는 것은 데이터베이스 연결에 많은 시간을 소모하게 된다. 이렇게 비효율적인 문제를 해결하기 위해서는 웹 애플리케이션이 실행됨과 동시에 연동할 데이터베이스와의 연결을 미리 설정해준다. 그리고 필요할 때마다 연결해 놓은 상태를 이용해 빠르게 데이터베이스와 연동하여 작업을 한다. 이렇게 미리 데이터베이스와 연결시킨 상태를 유지하는 기술을 커넥션풀(Connection Pool)이라고 부른다.



### 커넥션풀 동작 과정

톰캣 컨테이너에서 제공하는 커넥션풀의 동작 과정은 아래와 같다.

1. 톰캣 컨테이너를 실행한 후 응용 프로그램을 실행한다.
2. 톰캣 컨테이너 실행 시 커넥션풀 객체를 생성한다.
3. 생성된 커넥션 객체는 DBMS와 연결한다.
4. 데이터베이스와 연동 작업이 필요할 경우 응용 프로그램은 커넥션풀에서 제공하는 메소드를 호출하여 연동한다.

톰캣 컨테이너는 자체적으로 커넥션풀 기능을 제공한다. 톰캣 실행 시 톰캣은 설정 파일에 설정된 데이터베이스 정보를 이용해 미리 데이터베이스와 연결하여 커넥션풀 객체를 생성한 후 애플리케이션이 데이터베이스와 연동할 일이 생기면 커넥션풀 객체의 메서드를 호출해 빠르게 연동하여 작업한다.



### JNDI

실제 웹 애플리케이션에서 커넥션풀 객체를 구현할 때는 Java SE에서 제공하는 javax.sql.DataSource 클래스를 이용한다. 그리고 웹 애플리케이션 실행 시 톰캣이 만들어 놓은 커넥션풀 객체에 접근할 때는 JNDI를 이용한다.

JNDI(Java Naming and Directory Interface)란 필요한 자원을 키(Key)&값(Value) 쌍으로 저장한 후 필요할 때 키를 이용해 값을 얻는 방법이다. 즉, 미리 접근할 자원에 키를 지정한 후 애플리케이션이 실행 중일 때 이 키를 이용해 자원에 접근해서 작업을 하는 것이다.

JNDI 사용 예는 아래와 같다.

+ 웹 브라우저에서 name/value 쌍으로 전송한 후 서블릿에서 getParameter(name)으로 값을 가져올 때
+ 해시맵(HashMap)이나 해시테이블(HashTable)에 키와 값으로 저장한 후 키를 이용해 값을 가져올 때
+ 웹 브라우저에서 도메인 네임으로 DNS 서버에 요청할 경우 도메인 네임에 대한 IP 주소를 가져올 때

톰캣 컨테이너가 커넥션풀 객체를 생성하면 이 객체에 대한 JNDI 이름(Key)을 미리 설정해 놓는다. 그러면 웹 애플리케이션에서 데이터베이스와 연동 작업을 할 때 이 JNDI 이름(Key)으로 접근하여 작업한다.



### 톰캣의 DataSource 설정 및 사용 방법

실제 웹 애플리케이션에서 톰캣이 제공하는 커넥션풀 객체를 이용해 데이터베이스와 연동하는 과정은 아래와 같다.

1. JDBC 드라이버를 `WEB-INF/lib`에 설치한다.

2. 커넥션풀 기능 관련 jar 파일(`tomcat-dbcp`)을 `WEB-INF/lib`에 설치한다.

3. `CATALINA_HOME/context.xml`에 커넥션 객체 생성 시 연결할 데이터베이스 정보를 JNDI로 설정한다.

   ```xml
   <Context>
   	<Resource
       	name="jdbc/oracle"
       	auth="Container"
       	type="javax.sql.DataSource"
       	driverClassName="oracle.jdbc.OracleDriver"
       	url="jdbc:oracle:thin:@localhost:1521:xe"
       	username="CAFE"
       	password="1313" />
   </Context>
   ```

4. DAO 클래스에서 데이터베이스와 연동 시 미리 설정한 JNDI라는 이름으로 데이터베이스와 연결해서 작업한다.

실제 톰캣에서 커넥션풀 기능을 사용하기 위해서는, 이 기능을 제공하는 DBCP(DataBase Connection Pool) 라이브러리를 따로 받아야 한다. 이 라이브러리 파일은 jar 압축 파일 형태로 제공된다.



### 커넥션풀을 이용해 데이터베이스 내 회원정보 조회 (Web13 프로젝트 참고)

